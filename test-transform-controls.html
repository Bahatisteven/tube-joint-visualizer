<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transform Controls Test</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0a0a0a; }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: monospace;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 5px;
            max-width: 400px;
        }
        #info h3 { margin-top: 0; color: #4a9eff; }
        #info p { margin: 5px 0; font-size: 13px; }
        #info .status { color: #00ff00; font-weight: bold; }
        #info .error { color: #ff4444; }
    </style>
</head>
<body>
    <div id="info">
        <h3>üß™ TransformControls Test</h3>
        <p><strong>Instructions:</strong></p>
        <p>1. A blue cube should appear</p>
        <p>2. Click the cube (it turns yellow)</p>
        <p>3. You should see RED/GREEN/BLUE arrows</p>
        <p>4. Drag arrows to move the cube</p>
        <p><br><strong>Status:</strong></p>
        <p id="status">Initializing...</p>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "./node_modules/three/build/three.module.js",
            "three/addons/": "./node_modules/three/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';

        const statusEl = document.getElementById('status');
        function log(msg, isError = false) {
            console.log(msg);
            statusEl.innerHTML += `<br><span class="${isError ? 'error' : 'status'}">${msg}</span>`;
        }

        try {
            log('Creating scene...');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            log('Creating camera...');
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);

            log('Creating renderer...');
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            log('Adding lights...');
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 5, 5);
            scene.add(dirLight);

            log('Adding grid...');
            const grid = new THREE.GridHelper(10, 10);
            scene.add(grid);

            log('Creating test cube...');
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshStandardMaterial({ color: 0x4a9eff });
            const cube = new THREE.Mesh(geometry, material);
            scene.add(cube);
            log('‚úÖ Cube added to scene');

            log('Setting up OrbitControls...');
            const orbitControls = new OrbitControls(camera, renderer.domElement);
            orbitControls.enableDamping = true;
            log('‚úÖ OrbitControls ready');

            log('Setting up TransformControls...');
            const transformControls = new TransformControls(camera, renderer.domElement);
            transformControls.setMode('translate');
            transformControls.setSize(2.0);
            transformControls.setSpace('world');
            
            transformControls.addEventListener('dragging-changed', (event) => {
                orbitControls.enabled = !event.value;
                log(`Dragging: ${event.value}`);
            });
            
            scene.add(transformControls);
            log('‚úÖ TransformControls added to scene');
            log(`   - Size: ${transformControls.size}`);
            log(`   - Mode: ${transformControls.mode}`);
            log(`   - Space: ${transformControls.space}`);

            // Raycaster for clicking
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            renderer.domElement.addEventListener('click', (event) => {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(cube);

                if (intersects.length > 0) {
                    log('üñ±Ô∏è  Cube clicked!');
                    cube.material.color.setHex(0xffff00);
                    transformControls.attach(cube);
                    log('‚úÖ TransformControls attached to cube');
                    log(`   - Attached object: ${transformControls.object ? 'YES' : 'NO'}`);
                    log(`   - Visible: ${transformControls.visible}`);
                } else {
                    log('üñ±Ô∏è  Clicked empty space');
                    cube.material.color.setHex(0x4a9eff);
                    transformControls.detach();
                    log('TransformControls detached');
                }
            });

            log('üé¨ Starting animation loop...');
            
            function animate() {
                requestAnimationFrame(animate);
                orbitControls.update();
                renderer.render(scene, camera);
            }
            animate();

            log('‚úÖ ALL SYSTEMS GO! Click the cube!');

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

        } catch (error) {
            log(`‚ùå ERROR: ${error.message}`, true);
            console.error(error);
        }
    </script>
</body>
</html>
